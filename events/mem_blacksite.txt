#Blacksite
#By ViolentBeetle

namespace = mem_blacksite

@days_for_cycle = 1
@random_for_cycle = 1

#Gatekeeper event
country_event = {
    id = mem_blacksite.1
    hide_window = yes

    mean_time_to_happen = {
        months = 500
    }

    trigger = {
        NOT = { has_global_flag = mem_blacksite_happened }
        is_ai = no
        is_country_type = default
        years_passed > 10
        is_at_war = no
        any_country = {
            has_established_contact = ROOT
            is_country_type = fallen_empire
            OR = {
                has_ethic = ethic_fanatic_materialist
                has_ethic = ethic_fanatic_spiritualist
                has_ethic = ethic_fanatic_xenophile
            }
        }
        any_planet_within_border = {
            OR = {
                is_planet_class = pc_barren
                is_planet_class = pc_barren_cold
                is_planet_class = pc_toxic
                is_planet_class = pc_frozen
            }
            has_anomaly = no
            has_owner = no
            orbital_deposit_tile = { has_deposit = no }
            solar_system = {
                any_planet = { is_colonizable = no }
            }
        }
    }

    immediate = {
        set_global_flag = mem_blacksite_happened
        random_list = {
            0 = {  }
            35 = {
                random_planet_within_border = {
                    limit = {
                        OR = {
                            is_planet_class = pc_barren
                            is_planet_class = pc_barren_cold
                            is_planet_class = pc_toxic
                            is_planet_class = pc_frozen
                        }
                        has_anomaly = no
                        has_owner = no
                        orbital_deposit_tile = { has_deposit = no }
                        solar_system = {
                            any_planet = { is_colonizable = no }
                        }
                    }
                    save_event_target_as = blacksite_planet
                    set_planet_flag = mem_blacksite_planet
                }
                random_country = {
                    limit = {
                        has_established_contact = ROOT
                        is_country_type = fallen_empire
                        OR = {
                            has_ethic = ethic_fanatic_materialist
                            has_ethic = ethic_fanatic_spiritualist
                            has_ethic = ethic_fanatic_xenophile
                        }
                    }
                    save_event_target_as = blacksite_fallen_empire
                    set_country_flag = mem_blacksite_fallen_empire
                }
                set_country_flag = mem_blacksite_country
                country_event = { id = mem_blacksite.2 }
            }
        }
    }
}

#Initial greeting
country_event = {
    id = mem_blacksite.2
    title = mem_blacksite.2.name
    desc = mem_blacksite.2.desc

    is_triggered_only = yes
    location = event_target:blacksite_planet
    diplomatic = yes

    picture_event_data = {
		portrait = event_target:blacksite_fallen_empire
		planet_background = event_target:blacksite_fallen_empire
		graphical_culture = event_target:blacksite_fallen_empire
		city_level = event_target:blacksite_fallen_empire
		room = event_target:blacksite_fallen_empire.ruler
    }
    
    #Accept
    option = {
        name = mem_blacksite.2.a
        event_target:blacksite_fallen_empire = {
            add_opinion_modifier = {
                who = ROOT
                modifier = mem_blacksite_opinion_agreed
            }
        }
        custom_tooltip = mem_blacksite.2.a.tooltip
        hidden_effect = {
            event_target:blacksite_planet = {
                add_modifier = {
                    modifier = mem_blacksite_active
                    days = -1
                }
                planet_event = {
                    id = mem_blacksite.3
                    days = @days_for_cycle
                    random = @random_for_cycle
                }
            }
        }
    }

    #Decline
    option = {
        name = mem_blacksite.2.b
    }

    #Question
    option = {
        name = mem_blacksite.2.c
        response_text = mem_blacksite.2.c.response
        is_dialog_only = yes
    }
}

#Disambig event to tell what happens next
planet_event = {
    id = mem_blacksite.3
    hide_window = yes
    is_triggered_only = yes

    immediate = {
        IF = {
            limit = {
                NAND = {
                    exists = space_owner
                    space_owner = {
                        has_country_flag = mem_blacksite_country
                    }
                    exists = event_target:blacksite_fallen_empire
                }
            }
            remove_modifier = mem_blacksite_active
        }
        ELSE = {
            FROM = {
                random_list = {
                    1 = { #Successful
                        country_event = { id = mem_blacksite.400 }
                    }
                    1 = { #Self-destruct
                        country_event = { id = mem_blacksite.500 }
                    }
                    1 = { #Going dark
                        county_event = { id = mem_blacksite.600 }
                    }
                    1 = { #Infestation
                        country_event = { id = mem_blacksite.700 }
                    }
                    1 = { #Manhunt
                        country_event = { id = mem_blacksite.800 }
                    }
                }
            }
        }
    }
}

#########################
#SUCCESSFUL OUTCOME PATH#
#########################

country_event = {
    id = mem_blacksite.400
    title = mem_blacksite.400
    desc = mem_blacksite.400

    is_triggered_only = yes
    location = event_target:blacksite_planet
    diplomatic = yes

    picture_event_data = {
		portrait = event_target:blacksite_fallen_empire
		planet_background = event_target:blacksite_fallen_empire
		graphical_culture = event_target:blacksite_fallen_empire
		city_level = event_target:blacksite_fallen_empire
		room = event_target:blacksite_fallen_empire.ruler
    }

    option = {
        name = mem_blacksite.400.a

        add_monthly_resource_mult = {
            resource = society_research
            value = @tier3researchreward
            min = @tier3researchmin
            max = @tier3researchmax
        }
        add_monthly_resource_mult = {
            resource = physics_research
            value = @tier3researchreward
            min = @tier3researchmin
            max = @tier3researchmax
        }
        add_monthly_resource_mult = {
            resource = engineering_research
            value = @tier3researchreward
            min = @tier3researchmin
            max = @tier3researchmax
        }

        event_target:blacksite_planet = {
            remove_modifier = mem_blacksite_active
        }
    }
}

####################
#SELF-DESTRUCT PATH#
####################

#Actual explosion
country_event = {
    id = mem_blacksite.500
    title = mem_blacksite.500.name
    title = mem_blacksite.500.desc

    picture = GFX_evt_exploding_planet
    location = event_target:blacksite_planet
    show_sound = event_super_explosion

    is_triggered_only = yes

    immediate = {
        event_target:blacksite_planet = {
            change_pc = pc_shattered
            remove_modifier = mem_blacksite_active
            add_modifier = {
                modifier = mem_blacksite_debris
                days = -1
            }
        }
    }

    option = {
        name = mem_blacksite.500.a
        custom_tooltip = mem_blacksite.500.a.tooltip

        event_target:blacksite_planet = {
            orbital_deposit_tile = {
                set_deposit = d_large_physics_deposit
                add_deposit = d_large_engineering_deposit
            }
        }
        hidden_effect = {
            country_event = { id = mem_blacksite.501 days = 30 }
        }
    }
}

#Fallen Empire comms
country_event = {
    id = mem_blacksite.501
    title = mem_blacksite.501.name
    desc = mem_blacksite.501.desc

    is_triggered_only = yes
    location = event_target:blacksite_planet
    diplomatic = yes

    picture_event_data = {
		portrait = event_target:blacksite_fallen_empire
		planet_background = event_target:blacksite_fallen_empire
		graphical_culture = event_target:blacksite_fallen_empire
		city_level = event_target:blacksite_fallen_empire
		room = event_target:blacksite_fallen_empire.ruler
    }

    option = {
        name = mem_blacksite.501.a
    }

    option = {
        name = mem_blacksite.501.b
        response_text = mem_blacksite.501.b.response
        add_influence = 300

        event_target:blacksite_fallen_empire = {
            add_opinion_modifier = {
                who = ROOT
                modifier = mem_blacksite_impudent_brats
            }
        }
    }
}

############
#GOING DARK#
############

country_event = {
    id = mem_blacksite.600
    title = mem_blacksite.600.name
    desc = mem_blacksite.600.desc

    picture = GFX_evt_exploding_planet
    location = event_target:blacksite_planet
    show_sound = event_scanner

    is_triggered_only = yes

    option = {
        name = mem_blacksite.600.a
        custom_tooltip = mem_blacksite.600.a.tooltip

        event_target:blacksite_planet = {
            remove_modifier = mem_blacksite_active
            add_modifier = {
                modifier = mem_blacksite_blackout
                days = -1
            }
            enable_special_project = {
                name = MEM_BLACKSITE_INVESTIGATE
                location = THIS
                owner = ROOT
            }
        }
    }

    option = {
        name = mem_blacksite.600.b

        event_target:blacksite_fallen_empire = {
            add_opinion_modifier = {
                who = ROOT
                modifier = mem_blacksite_breach
            }
        }

        event_target:blacksite_planet = {
            remove_modifier = mem_blacksite_active
            add_modifier = {
                modifier = mem_blacksite_blackout
                days = -1
            }
            orbital_deposit_tile = {
                add_deposit = d_immense_physics_deposit
                add_deposit = d_immense_engineering_deposit
            }
        }
    }

    option = {
        name = mem_blacksite.600.c
        custom_tooltip = mem_blacksite.600.c.tooltip

        event_target:blacksite_planet = {
            remove_modifier = mem_blacksite_active
            add_modifier = {
                modifier = mem_blacksite_blackout
                days = -1
            }
        }
    }
}

#Research complete - disambiguation
ship_event = {
    id = mem_blacksite.601
    is_triggered_only = yes
    hide_window = yes

    immediate = {
        owner = {
            random_list = {
                1 = { #Empty
                    country_event = { id = mem_blacksite.602 }
                }
                1 = { #Surviving scientist
                    country_event = { id = mem_blacksite.603 }
                }
                1 = { #Psionic construct
                    country_event = { id = mem_blacksite.604 }
                    modifier = {
                        factor = 0
                        exists = event_target:blacklist_fallen_empire
                        event_target:blacklist_fallen_empire = {
                            has_ethic = ethic_fanatic_materialist
                        }
                    }
                }
                1 = { #Synthetic construct
                    country_event = { id = mem_blacksite.605 }
                    modifier = {
                        factor = 0
                        exists = event_target:blacklist_fallen_empire
                        event_target:blacklist_fallen_empire = {
                            has_ethic = ethic_fanatic_spiritualist
                        }
                    }
                }
            }
        }
    }
}

#Empty
country_event = {
    id = mem_blacksite.602
    title = mem_blacksite.602.name
    title = mem_blacksite.602.desc

    picture = GFX_evt_derelict_interior
    location = event_target:blacksite_planet
    show_sound = event_scanner

    is_triggered_only = yes

    option = {
        name = mem_blacksite.602.a
    }

    after = { #FE is not amused
        event_target:blacksite_planet = {
            orbital_deposit_tile = {
                add_deposit = d_immense_physics_deposit
                add_deposit = d_immense_engineering_deposit
            }
        }
        event_target:blacksite_fallen_empire = {
            add_opinion_modifier = {
                who = ROOT
                modifier = mem_blacksite_rummaged
            }
        }
    }
}

#Found scientist
country_event = {
    id = mem_blacksite.603
    title = mem_blacksite.603.name
    title = mem_blacksite.603.desc

    picture = GFX_evt_mem_horror_corridor
    location = event_target:blacksite_planet
    show_sound = event_scanner

    is_triggered_only = yes

    option = {
        name = mem_blacksite.602.a
        custom_tooltip = mem_blacksite.602.a.tooltip

        hidden_effect = {
            create_leader = {
                name = random
                type = scientist
                skill = 5
                species = event_target:blacksite_fallen_empire
                effect = {
                    add_trait = mem_blacksite_trait_fallen_empire_scientist
                }
            }
        }
        event_target:blacksite_fallen_empire = {
            add_opinion_modifier = {
                who = ROOT
                modifier = mem_blacksite_rummaged
            }
        }
    }

    option = {
        name = mem_blacksite.602.b

        event_target:blacksite_fallen_empire = {
            add_opinion_modifier = {
                who = ROOT
                modifier = mem_blacksite_returned_scienstist
            }
        }
    }

    after = {
        event_target:blacksite_planet = {
            orbital_deposit_tile = {
                add_deposit = d_immense_physics_deposit
                add_deposit = d_immense_engineering_deposit
            }
        }
    }
}

#Psi-construct
country_event = {
    id = mem_blacksite.604
    title = mem_blacksite.604.name
    title = mem_blacksite.604.desc

    picture = GFX_evt_mem_horror_corridor
    location = event_target:blacksite_planet
    show_sound = event_scanner

    is_triggered_only = yes

    option = {
        name = mem_blacksite.604.a
        custom_tooltip = mem_blacksite.604.a.tooltip

        hidden_effect = {
            create_leader = {
                name = "Subject 31"
                type = scientist
                skill = 5
                traits = {
                    trait = mem_blacksite_trait_psionic_project
                }
                species = event_target:blacksite_fallen_empire
                effect = {
                    save_event_target_as = blacksite_recovered_leader
                    set_leader_flag = mem_blacksite_recovered_leader
                }
            }
        }
        event_target:blacksite_fallen_empire = {
            add_opinion_modifier = {
                who = ROOT
                modifier = mem_blacksite_rummaged
            }
        }
        hidden_effect = {
            random_list = {
                50 = {
                    country_event = {
                        id = mem_blacksite.620
                        days = 360
                        random = 3600
                    }
                }
                50 = {
                    country_event = {
                        id = mem_blacksite.610
                        days = 360
                        random = 360
                    }
                }
            }
        }
    }

    option = {
        name = mem_blacksite.604.b

        event_target:blacksite_fallen_empire = {
            add_opinion_modifier = {
                who = ROOT
                modifier = mem_blacksite_returned_subject
            }
        }
    }

    after = {
        event_target:blacksite_planet = {
            orbital_deposit_tile = {
                add_deposit = d_immense_physics_deposit
                add_deposit = d_immense_engineering_deposit
            }
        }
    }
}

#Machine construct
country_event = {
    id = mem_blacksite.605
    title = mem_blacksite.605.name
    title = mem_blacksite.605.desc

    picture = GFX_evt_mem_horror_corridor
    location = event_target:blacksite_planet
    show_sound = event_scanner

    is_triggered_only = yes

    option = {
        name = mem_blacksite.605.a
        custom_tooltip = mem_blacksite.605.a.tooltip

        hidden_effect = {
            create_species = {
				name = "NAME_AI"
				class = ROBOT
				portrait = random
				traits = random
			}
            create_leader = {
                name = "Project 11"
                type = scientist
                skill = 5
                traits = {
                    trait = mem_blacksite_trait_synthetic_project
                }
                species = last_created_species
                effect = {
                    save_event_target_as = blacksite_recovered_leader
                    set_leader_flag = mem_blacksite_recovered_leader
                }
            }
        }
        event_target:blacksite_fallen_empire = {
            add_opinion_modifier = {
                who = ROOT
                modifier = mem_blacksite_rummaged
            }
        }
        hidden_effect = {
            random_list = {
                50 = {
                    country_event = {
                        id = mem_blacksite.630
                        days = 360
                        random = 3600
                    }
                }
                50 = {
                    country_event = {
                        id = mem_blacksite.610
                        days = 360
                        random = 360
                    }
                }
            }
        }
    }

    option = {
        name = mem_blacksite.605.b

        event_target:blacksite_fallen_empire = {
            add_opinion_modifier = {
                who = ROOT
                modifier = mem_blacksite_returned_subject
            }
        }
    }

    after = {
        event_target:blacksite_planet = {
            orbital_deposit_tile = {
                add_deposit = d_immense_physics_deposit
                add_deposit = d_immense_engineering_deposit
            }
        }
    }
}

#Diplomatic event, Fallen empire request return - will not fire if you delete the leader
country_event = {
    id = mem_blacksite.610
    title = mem_blacksite.610.name
    desc = mem_blacksite.610.desc

    is_triggered_only = yes
    location = event_target:blacksite_planet
    diplomatic = yes

    trigger = {
        any_owned_leader = {
            has_leader_flag = mem_blacksite_recovered_leader
        }
    }

    picture_event_data = {
		portrait = event_target:blacksite_fallen_empire
		planet_background = event_target:blacksite_fallen_empire
		graphical_culture = event_target:blacksite_fallen_empire
		city_level = event_target:blacksite_fallen_empire
		room = event_target:blacksite_fallen_empire.ruler
    }

    option = {
        name = mem_blacksite.610.a
        custom_tooltip = mem_blacksite.610.a.tooltip
        hidden_effect = {
            event_target:blacksite_recovered_leader = {
                kill_leader = { type = scienstist show_notification = no }
            }
        }
        event_target:blacksite_fallen_empire = {
            add_opinion_modifier = {
                who = ROOT
                modifier = mem_blacksite_belated_cooperation
            }
        }
    }

    option = {
        name = mem_blacksite.610.b
        custom_tooltip = mem_blacksite.610.b.tooltip
        hidden_effect = {
            IF = {
                limit = {
                    event_target:blacksite_recovered_leader.species = {
                        is_species_class = ROBOT
                    }
                }
                country_event = { id = mem_blacksite.630 }
            }
            ELSE = {
                country_event = { id = mem_blacksite.620 }
            }
        }
    }
}

#Disambiguation for fate of psionic leader
country_event = {
    id = mem_blacksite.620
    is_triggered_only = yes
    hide_window = yes

    trigger = {
        exists = event_target:blacksite_recovered_leader
    }

    immediate = {
        random_list = {
            50 = { #Benign outcome
                modifier = {
                    factor = 0
                    has_country_flag = mem_blacksite_leader_escaped
                }
            }
            50 = { #Negative outcomes
                IF = { #Runaway - if commanding a ship
                    limit = {
                        any_owned_ship = {
                            exists = leader
                            leader = { is_same_value = event_target:blacksite_recovered_leader }
                        }
                    }
                    random_owned_ship = {
                        limit = {
                            exists = leader
                            leader = { is_same_value = event_target:blacksite_recovered_leader }
                        }
                        ship_event = { id = mem_blacksite.621 }
                    }
                }
                ELSE = {
                    random_list = {
                        5 = { #Trashed his own department
                            country_event = { id = mem_blacksite.622 }
                            modifier = {
                                factor = 0
                                event_target:blacksite_recovered_leader = {
                                    NOR = {
                                        is_researching_area = engineering 
                                        is_researching_area = physics 
                                        is_researching_area = society
                                    }
                                }
                            }
                        }
                        2 = { #Trashing everything
                            country_event = { id = mem_blacksite.623 }
                        }
                        20 = { #Smitten by a chosen one
                            country_event = { id = mem_blacksite.624 }
                            modifier = {
                                factor = 0
                                NOT = {
                                    any_owned_leader = {
                                        OR = {
                                            has_trait = leader_trait_admiral_chosen
                                            has_trait = leader_trait_general_chosen
                                            has_trait = leader_trait_scientist_chosen
                                            has_trait = leader_trait_governor_chosen
                                            has_trait = leader_trait_ruler_chosen
                                        }
                                    }
                                }
                            }
                        }
                        3 = { #Psionic rampage
                            country_event = { id = mem_blacksite.625 }
                            modifier = {
                                factor = 0
                                NOT = {
                                    any_owned_leader = {
                                        OR = {
                                            has_trait = leader_trait_admiral_psionic
                                            has_trait = leader_trait_general_psionic
                                            has_trait = leader_trait_scientist_psionic
                                            has_trait = leader_trait_governor_psionic
                                            has_trait = leader_trait_ruler_psionic
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
            }
        }
    }
}

#Wrecked ship
ship_event = {
    id = mem_blacksite.621
    title = mem_blacksite.621.name
    desc = mem_blacksite.621.desc

    location = ROOT
    picture = GFX_evt_debris
    show_sound = event_super_explosion

    is_triggered_only = yes
    
    immediate = {
        leader = {
            exile_leader_as = mem_blacksite_runaway
        }
        destroy_ship = this
        owner = {
            country_event = { id = mem_blacksite.620 days = 120 random = 360 }
        }
    }

    option = {
        name = mem_blacksite.621.a
        tooltip = {
            destroy_ship = this
        }
        custom_tolltip = mem_blacksite.621.a.tooltip
    }
}

#Trashed his department
country_event = {
    id = mem_blacksite.622
    title = mem_blacksite.622.name
    desc = {
        text = mem_blacksite.622.physics
        trigger = {
            has_country_flag = mem_blacksite_trashed_physics
        }
    }
    desc = {
        text = mem_blacksite.622.society
        trigger = {
            has_country_flag = mem_blacksite_trashed_society
        }
    }
    desc = {
        text = mem_blacksite.622.engineering
        trigger = {
            has_country_flag = mem_blacksite_trashed_engineering
        }
    }

    picture = GFX_evt_surreal_visions
    show_sound = event_super_explosion

    is_triggered_only = yes

    immediate = {
        IF = {
            limit = {
                event_target:blacksite_recovered_leader = {
                    is_researching_area = physics
                }
            }
            set_country_flag = mem_blacksite_trashed_physics
            add_modifier = {
                modifier = mem_blacksite_trashed_physics
                days = 1800
            }
        }
        ELSE_IF = {
            limit = {
                event_target:blacksite_recovered_leader = {
                    is_researching_area = society
                }
            }
            set_country_flag = mem_blacksite_trashed_society
            add_modifier = {
                modifier = mem_blacksite_trashed_society
                days = 1800
            }
        }
        ELSE = {
            set_country_flag = mem_blacksite_trashed_engineering
            add_modifier = {
                modifier = mem_blacksite_trashed_engineering
                days = 1800
            }
        }
        event_target:blacksite_recovered_leader = {
            kill_leader = { type = scientist notification = no }
        }
    }

    option = {
        name = mem_blacksite.622.a
        tooltip = {
            IF = {
                limit = {
                    event_target:blacksite_recovered_leader = {
                        is_researching_area = physics
                    }
                }
                add_modifier = {
                    modifier = mem_blacksite_trashed_physics
                    days = 1800
                }
            }
            ELSE_IF = {
                limit = {
                    event_target:blacksite_recovered_leader = {
                        is_researching_area = society
                    }
                }
                add_modifier = {
                    modifier = mem_blacksite_trashed_society
                    days = 1800
                }
            }
            ELSE = {
                add_modifier = {
                    modifier = mem_blacksite_trashed_engineering
                    days = 1800
                }
            }
        }
    }
}

#Trashing everything
country_event = {
    id = mem_blacksite.623
    title = mem_blacksite.623.name
    desc = mem_blacksite.623.desc

    picture = GFX_evt_surreal_visions
    show_sound = event_super_explosion

    is_triggered_only = yes

    immediate = {
        add_modifier = {
            modifier = mem_blacksite_trashed_everything
            days = 1800
        }
        event_target:blacksite_recovered_leader = {
            kill_leader = { type = scientist notification = no }
        }
    }

    option = {
        name = mem_blacksite.623.a
    }
}

#Smitten by chosen one
country_event = {
    id = mem_blacksite.624
    title = mem_blacksite.624.name
    desc = mem_blacksite.624.desc

    picture = GFX_evt_surreal_visions
    show_sound = event_super_explosion

    is_triggered_only = yes

    immediate = {
        random_owned_leader = {
            limit = {
                OR = {
                    has_trait = leader_trait_admiral_chosen
                    has_trait = leader_trait_general_chosen
                    has_trait = leader_trait_scientist_chosen
                    has_trait = leader_trait_governor_chosen
                    has_trait = leader_trait_ruler_chosen
                }
            }
        }
        event_target:blacksite_recovered_leader = {
            kill_leader = { type = scientist notification = no }
        }
    }

    option = {
        name = mem_blacksite.624.a
    }
}

