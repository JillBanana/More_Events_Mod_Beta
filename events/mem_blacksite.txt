#Blacksite
#By ViolentBeetle

namespace = mem_blacksite

@days_for_cycle = 1
@random_for_cycle = 1

#Gatekeeper event
country_event = {
    id = mem_blacksite.1
    hide_window = yes

    mean_time_to_happen = {
        months = 500
    }

    trigger = {
        NOT = { has_global_flag = mem_blacksite_happened }
        is_ai = no
        is_country_type = default
        years_passed > 10
        is_at_war = no
        any_country = {
            has_established_contact = ROOT
            is_country_type = fallen_empire
            OR = {
                has_ethic = ethic_fanatic_materialist
                has_ethic = ethic_fanatic_spiritualist
                has_ethic = ethic_fanatic_xenophile
            }
        }
        any_planet_within_border = {
            OR = {
                is_planet_class = pc_barren
                is_planet_class = pc_barren_cold
                is_planet_class = pc_toxic
                is_planet_class = pc_frozen
            }
            has_anomaly = no
            has_owner = no
            orbital_deposit_tile = { has_deposit = no }
            solar_system = {
                any_planet = { is_colonizable = no }
            }
        }
    }

    immediate = {
        set_global_flag = mem_blacksite_happened
        random_list = {
            0 = {  }
            35 = {
                random_planet_within_border = {
                    limit = {
                        OR = {
                            is_planet_class = pc_barren
                            is_planet_class = pc_barren_cold
                            is_planet_class = pc_toxic
                            is_planet_class = pc_frozen
                        }
                        has_anomaly = no
                        has_owner = no
                        orbital_deposit_tile = { has_deposit = no }
                        solar_system = {
                            any_planet = { is_colonizable = no }
                        }
                    }
                    save_event_target_as = blacksite_planet
                    set_planet_flag = mem_blacksite_planet
                }
                random_country = {
                    limit = {
                        has_established_contact = ROOT
                        is_country_type = fallen_empire
                        OR = {
                            has_ethic = ethic_fanatic_materialist
                            has_ethic = ethic_fanatic_spiritualist
                            has_ethic = ethic_fanatic_xenophile
                        }
                    }
                    save_event_target_as = blacksite_fallen_empire
                    set_country_flag = mem_blacksite_fallen_empire
                }
                set_country_flag = mem_blacksite_country
                country_event = { id = mem_blacksite.2 }
            }
        }
    }
}

#Initial greeting
country_event = {
    id = mem_blacksite.2
    title = mem_blacksite.2.name
    desc = mem_blacksite.2.desc

    is_triggered_only = yes
    location = event_target:blacksite_planet
    diplomatic = yes

    picture_event_data = {
		portrait = event_target:blacksite_fallen_empire
		planet_background = event_target:blacksite_fallen_empire
		graphical_culture = event_target:blacksite_fallen_empire
		city_level = event_target:blacksite_fallen_empire
		room = event_target:blacksite_fallen_empire.ruler
    }
    
    #Accept
    option = {
        name = mem_blacksite.2.a
        event_target:blacksite_fallen_empire = {
            add_opinion_modifier = {
                who = ROOT
                modifier = mem_blacksite_opinion_agreed
            }
        }
        custom_tooltip = mem_blacksite.2.a.tooltip
        hidden_effect = {
            event_target:blacksite_planet = {
                add_modifier = {
                    modifier = mem_blacksite_active
                    days = -1
                }
                planet_event = {
                    id = mem_blacksite.3
                    days = @days_for_cycle
                    random = @random_for_cycle
                }
            }
        }
    }

    #Decline
    option = {
        name = mem_blacksite.2.b
    }

    #Question
    option = {
        name = mem_blacksite.2.c
        response_text = mem_blacksite.2.c.response
        is_dialog_only = yes
    }
}

#Disambig event to tell what happens next
planet_event = {
    id = mem_blacksite.3
    hide_window = yes
    is_triggered_only = yes

    immediate = {
        IF = {
            limit = {
                NAND = {
                    exists = space_owner
                    space_owner = {
                        has_country_flag = mem_blacksite_country
                    }
                    exists = event_target:blacksite_fallen_empire
                }
            }
            remove_modifier = mem_blacksite_active
        }
        ELSE = {
            FROM = {
                random_list = {
                    1 = { #Successful
                        country_event = { id = mem_blacksite.400 }
                    }
                    1 = { #Self-destruct
                        country_event = { id = mem_blacksite.500 }
                    }
                    1 = { #Going dark
                        county_event = { id = mem_blacksite.600 }
                    }
                    1 = { #Infestation
                        country_event = { id = mem_blacksite.700 }
                    }
                    1 = { #Manhunt
                        country_event = { id = mem_blacksite.800 }
                    }
                }
            }
        }
    }
}

#########################
#SUCCESSFUL OUTCOME PATH#
#########################

country_event = {
    id = mem_blacksite.400
    title = mem_blacksite.400
    desc = mem_blacksite.400

    is_triggered_only = yes
    location = event_target:blacksite_planet
    diplomatic = yes

    picture_event_data = {
		portrait = event_target:blacksite_fallen_empire
		planet_background = event_target:blacksite_fallen_empire
		graphical_culture = event_target:blacksite_fallen_empire
		city_level = event_target:blacksite_fallen_empire
		room = event_target:blacksite_fallen_empire.ruler
    }

    option = {
        name = mem_blacksite.400.a

        add_monthly_resource_mult = {
            resource = society_research
            value = @tier3researchreward
            min = @tier3researchmin
            max = @tier3researchmax
        }
        add_monthly_resource_mult = {
            resource = physics_research
            value = @tier3researchreward
            min = @tier3researchmin
            max = @tier3researchmax
        }
        add_monthly_resource_mult = {
            resource = engineering_research
            value = @tier3researchreward
            min = @tier3researchmin
            max = @tier3researchmax
        }

        event_target:blacksite_planet = {
            remove_modifier = mem_blacksite_active
        }
    }
}

####################
#SELF-DESTRUCT PATH#
####################

#Actual explosion
country_event = {
    id = mem_blacksite.500
    title = mem_blacksite.500.name
    title = mem_blacksite.500.desc

    picture = GFX_evt_exploding_planet
    location = event_target:blacksite_planet
    show_sound = event_super_explosion

    is_triggered_only = yes

    immediate = {
        event_target:blacksite_planet = {
            change_pc = pc_shattered
            remove_modifier = mem_blacksite_active
            add_modifier = {
                modifier = mem_blacksite_debris
                days = -1
            }
        }
    }

    option = {
        name = mem_blacksite.500.a
        custom_tooltip = mem_blacksite.500.a.tooltip

        event_target:blacksite_planet = {
            orbital_deposit_tile = {
                set_deposit = d_large_physics_deposit
                add_deposit = d_large_engineering_deposit
            }
        }
        hidden_effect = {
            country_event = { id = mem_blacksite.501 days = 30 }
        }
    }
}

#Fallen Empire comms
country_event = {
    id = mem_blacksite.501
    title = mem_blacksite.501
    desc = mem_blacksite.501

    is_triggered_only = yes
    location = event_target:blacksite_planet
    diplomatic = yes

    picture_event_data = {
		portrait = event_target:blacksite_fallen_empire
		planet_background = event_target:blacksite_fallen_empire
		graphical_culture = event_target:blacksite_fallen_empire
		city_level = event_target:blacksite_fallen_empire
		room = event_target:blacksite_fallen_empire.ruler
    }

    option = {
        name = mem_blacksite.501.a
    }

    option = {
        name = mem_blacksite.501.b
        response_text = mem_blacksite.501.b.response
        add_influence = 300

        event_target:blacksite_fallen_empire = {
            add_opinion_modifier = {
                who = ROOT
                modifier = mem_blacksite_impudent_brats
            }
        }
    }
}

############
#GOING DARK#
############

country_event = {
    id = mem_blacksite.600
    title = mem_blacksite.600.name
    desc = mem_blacksite.600.desc

    picture = GFX_evt_exploding_planet
    location = event_target:blacksite_planet
    show_sound = event_scanner

    is_triggered_only = yes

    option = {
        name = mem_blacksite.600.a
        custom_tooltip = mem_blacksite.600.a.tooltip

        event_target:blacksite_planet = {
            remove_modifier = mem_blacksite_active
            add_modifier = {
                modifier = mem_blacksite_blackout
                days = -1
            }
            enable_special_project = {
                name = MEM_BLACKSITE_INVESTIGATE
                location = THIS
                owner = ROOT
            }
        }
    }

    option = {
        name = mem_blacksite.600.b

        event_target:blacksite_fallen_empire = {
            add_opinion_modifier = {
                who = ROOT
                modifier = mem_blacksite_breach
            }
        }

        event_target:blacksite_planet = {
            remove_modifier = mem_blacksite_active
            add_modifier = {
                modifier = mem_blacksite_blackout
                days = -1
            }
            orbital_deposit_tile = {
                add_deposit = d_immense_physics_deposit
                add_deposit = d_immense_engineering_deposit
            }
        }
    }

    option = {
        name = mem_blacksite.600.c
        custom_tooltip = mem_blacksite.600.c.tooltip

        event_target:blacksite_planet = {
            remove_modifier = mem_blacksite_active
            add_modifier = {
                modifier = mem_blacksite_blackout
                days = -1
            }
        }
    }
}

#Research complete - disambiguation
ship_event = {
    id = mem_blacksite.601
    is_triggered_only = yes
    hide_window = yes

    immediate = {
        owner = {
            random_list = {
                1 = { #Empty
                    country_event = { id = mem_blacksite.602 }
                }
                1 = { #Surviving scientist
                    country_event = { id = mem_blacksite.603 }
                }
                1 = { #Psionic construct
                    country_event = { id = mem_blacksite.604 }
                    modifier = {
                        factor = 0
                        exists = event_target:blacklist_fallen_empire
                        event_target:blacklist_fallen_empire = {
                            has_ethic = ethic_fanatic_materialist
                        }
                    }
                }
                1 = { #Synthetic construct
                    country_event = { id = mem_blacksite.605 }
                    modifier = {
                        factor = 0
                        exists = event_target:blacklist_fallen_empire
                        event_target:blacklist_fallen_empire = {
                            has_ethic = ethic_fanatic_spiritualist
                        }
                    }
                }
            }
        }
    }
}

#Empty
country_event = {
    id = mem_blacksite.602
    title = mem_blacksite.602.name
    title = mem_blacksite.602.desc

    picture = GFX_evt_derelict_interior
    location = event_target:blacksite_planet
    show_sound = event_scanner

    is_triggered_only = yes

    option = {
        name = mem_blacksite.602.a
    }

    after = { #FE is not amused
        event_target:blacksite_planet = {
            orbital_deposit_tile = {
                add_deposit = d_immense_physics_deposit
                add_deposit = d_immense_engineering_deposit
            }
        }
        event_target:blacksite_fallen_empire = {
            add_opinion_modifier = {
                who = ROOT
                modifier = mem_blacksite_rummaged
            }
        }
    }
}

#Found scientist
country_event = {
    id = mem_blacksite.603
    title = mem_blacksite.603.name
    title = mem_blacksite.603.desc

    picture = GFX_evt_mem_horror_corridor
    location = event_target:blacksite_planet
    show_sound = event_scanner

    is_triggered_only = yes

    option = {
        name = mem_blacksite.602.a
        custom_tooltip = mem_blacksite.602.a.tooltip

        hidden_effect = {
            create_leader = {
                name = random
                type = scientist
                skill = 5
                species = event_target:blacksite_fallen_empire
                effect = {
                    add_trait = mem_blacksite_trait_fallen_empire_scientist
                }
            }
        }
        event_target:blacksite_fallen_empire = {
            add_opinion_modifier = {
                who = ROOT
                modifier = mem_blacksite_rummaged
            }
        }
    }

    option = {
        name = mem_blacksite.602.b

        event_target:blacksite_fallen_empire = {
            add_opinion_modifier = {
                who = ROOT
                modifier = mem_blacksite_returned_scienstist
            }
        }
    }

    after = {
        event_target:blacksite_planet = {
            orbital_deposit_tile = {
                add_deposit = d_immense_physics_deposit
                add_deposit = d_immense_engineering_deposit
            }
        }
    }
}

#Psi-construct
country_event = {
    id = mem_blacksite.603
    title = mem_blacksite.603.name
    title = mem_blacksite.603.desc

    picture = GFX_evt_mem_horror_corridor
    location = event_target:blacksite_planet
    show_sound = event_scanner

    option = {
        name = mem_blacksite.603.a
        custom_tooltip = mem_blacksite.603.a.tooltip

        hidden_effect = {
            create_leader = {
                name = "Subject 31"
                type = scientist
                skill = 5
                traits = {
                    trait = mem_blacksite_trait_psionic_project
                }
                species = event_target:blacksite_fallen_empire
                effect = {
                    save_event_target_as = blacksite_recovered_leader
                    set_leader_flag = mem_blacksite_recovered_leader
                }
            }
        }
        event_target:blacksite_fallen_empire = {
            add_opinion_modifier = {
                who = ROOT
                modifier = mem_blacksite_rummaged
            }
        }
        hidden_effect = {
            random_list = {
                50 = {
                    country_event = {
                        id = mem_blacksite.620
                        days = 360
                        random = 3600
                    }
                }
                50 = {
                    country_event = {
                        id = mem_blacksite.610
                        days = 360
                        random = 360
                    }
                }
            }
        }
    }

    option = {
        name = mem_blacksite.603.b

        event_target:blacksite_fallen_empire = {
            add_opinion_modifier = {
                who = ROOT
                modifier = mem_blacksite_returned_subject
            }
        }
    }

    after = {
        event_target:blacksite_planet = {
            orbital_deposit_tile = {
                add_deposit = d_immense_physics_deposit
                add_deposit = d_immense_engineering_deposit
            }
        }
    }
}

#Machine construct
country_event = {
    id = mem_blacksite.604
    title = mem_blacksite.604.name
    title = mem_blacksite.604.desc

    picture = GFX_evt_mem_horror_corridor
    location = event_target:blacksite_planet
    show_sound = event_scanner

    option = {
        name = mem_blacksite.604.a
        custom_tooltip = mem_blacksite.604.a.tooltip

        hidden_effect = {
            create_species = {
				name = "NAME_AI"
				class = ROBOT
				portrait = random
				traits = random
			}
            create_leader = {
                name = "Project 11"
                type = scientist
                skill = 5
                traits = {
                    trait = mem_blacksite_trait_synthetic_project
                }
                species = last_created_species
                effect = {
                    save_event_target_as = mem_blacksite_recovered_leader
                    set_leader_flag = mem_blacksite_recovered_leader
                }
            }
        }
        event_target:blacksite_fallen_empire = {
            add_opinion_modifier = {
                who = ROOT
                modifier = mem_blacksite_rummaged
            }
        }
        hidden_effect = {
            random_list = {
                50 = {
                    country_event = {
                        id = mem_blacksite.630
                        days = 360
                        random = 3600
                    }
                }
                50 = {
                    country_event = {
                        id = mem_blacksite.610
                        days = 360
                        random = 360
                    }
                }
            }
        }
    }

    option = {
        name = mem_blacksite.603.b

        event_target:blacksite_fallen_empire = {
            add_opinion_modifier = {
                who = ROOT
                modifier = mem_blacksite_returned_subject
            }
        }
    }

    after = {
        event_target:blacksite_planet = {
            orbital_deposit_tile = {
                add_deposit = d_immense_physics_deposit
                add_deposit = d_immense_engineering_deposit
            }
        }
    }
}